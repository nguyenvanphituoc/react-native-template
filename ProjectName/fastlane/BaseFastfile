before_all do | options |
  unless (ENV["MATCH_PASSWORD"])
    UI.user_error! "Not define enough environment variable, please export these variables: [MATCH_PASSWORD]"
    return
  end

  # set version for iOS
  sh("./version.ios.sh --version-code \"#{get_current_timestamp}\"")
  get_version = `#{ENV["GET_VERSION"]}`

  IPA_PATH = "build/#{ENV["APP_NAME"]}.ipa"
  APK_PATH = "./android/app/build/outputs/apk/#{ENV["FLAVOR"]}/release/app-#{ENV["FLAVOR"]}-release.apk"
  INFO = "#{ENV["APP_NAME"]} #{get_version}"

  print("IPA_PATH #{IPA_PATH}")
  print("APK_PATH #{APK_PATH}")
  print("INFO #{INFO}")
end

lane :watch do
  sh("watchbuild -a #{ENV["APP_ID"]} -u #{ENV["APPLE_USER_NAME"]}")
end

# def get_build_message
#   `cat ../package.json | grep message | head -1 | awk -F: '{ print $2 }' | sed 's/[\",]//g'`.strip
# end
def get_build_message
  file = File.read('../package.json')
  data = JSON.parse(file)
  data['message'].strip
end

def print(variable)
  sh("echo #{variable}")
end

def set_build_number(build_number = nil)
  raise if build_number.nil?

  puts "Setting build number to #{build_number}"
  Actions.lane_context[SharedValues::BUILD_NUMBER] = "#{build_number}"
  sh("/usr/libexec/PlistBuddy -c 'Set CFBundleVersion #{build_number}' ../#{ENV["APP_PLIST"]}")
end

def get_current_timestamp
  current_time = Time.now
  timestamp_format = "%Y%m%d%H"  # Format: YYYYMMDDHHMM
  formatted_timestamp = current_time.strftime(timestamp_format)
  return formatted_timestamp
end
